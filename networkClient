from twisted.internet.protocol import ClientFactory
from twisted.internet.protocol import Protocol
from twisted.internet import reactor
from twisted.internet import task
import time
from twisted.internet import defer
import sys, pygame, os
from pygame.locals import *
import math
import random

class Target(pygame.sprite.Sprite):
	def __init__(self, gs, x, y):
		pygame.sprite.Sprite.__init__(self)
		self.gs = gs
		self.image = pygame.transform.scale(pygame.image.load("like_button.png"), (50, 50))
		self.rect = self.image.get_rect()
		self.rect.topleft = int(x), int(y)
		self.dead = 0
		
	def destroy(self):
		self.kill()
		
	def tick(self):
		gs.screen.blit(self.image, self.rect)
		
class Fade(pygame.sprite.Sprite):
	def __init__(self, gs, center):
		pygame.sprite.Sprite.__init__(self)
		self.gs = gs
		size = 50, 50
		self.image = pygame.transform.scale(pygame.image.load("liked_button.png"), size).convert()
		self.rect = self.image.get_rect()
		self.rect.center = center
		self.count = 255
		
	def tick(self):
		self.image.set_alpha(self.count)
		self.count -= 45
		if(self.count <= 0):
			self.kill()
		gs.screen.blit(self.image, self.rect)
		
		
class Smoke(pygame.sprite.Sprite):
	def __init__(self, gs, center):
		pygame.sprite.Sprite.__init__(self)
		self.gs = gs
		self.images = []
		size = 75, 75
		self.image = pygame.transform.scale(pygame.image.load("smoke_plume_0001.png"), size)
		self.images.append(pygame.transform.scale(pygame.image.load("smoke_plume_0002.png"), size))
		self.images.append(pygame.transform.scale(pygame.image.load("smoke_plume_0003.png"), size))
		self.images.append(pygame.transform.scale(pygame.image.load("smoke_plume_0004.png"), size))		#free images from Pow Studios
		self.images.append(pygame.transform.scale(pygame.image.load("smoke_plume_0005.png"), size))
		self.images.append(pygame.transform.scale(pygame.image.load("smoke_plume_0006.png"), size))
		self.images.append(pygame.transform.scale(pygame.image.load("smoke_plume_0007.png"), size))
		self.images.append(pygame.transform.scale(pygame.image.load("smoke_plume_0008.png"), size))
		self.images.append(pygame.transform.scale(pygame.image.load("smoke_plume_0009.png"), size))
		self.images.append(pygame.transform.scale(pygame.image.load("smoke_plume_0010.png"), size))
		self.rect = self.image.get_rect()
		self.rect.center = center
		self.count = 0
		
	def tick(self):
		if(self.count > 7):
			self.kill()
			return
		self.image = self.images[self.count]
		self.gs.screen.blit(self.image, self.rect)
		self.count += 1


class ClientConnection(Protocol):
	
	def __init__(self, gs):
		self.connected = 0
		self.gs = gs
		self.gs.injectCC(self)

	def connectionMade(self):
		self.gs.state = "Wait"
		self.gs.waitingMode()
		self.conneced = 1
		
		
	def dataReceived(self, data):
		if "Ready" in data:
			self.gs.gameTime()
		if "kill1" in data:
			self.gs.kill1()
		if "coor" in data:
			line = data.split(";")
			self.gs.fb.add(Target(self.gs, line[1], line[2]))
			self.gs.targs.append(Target(self.gs, line[1], line[2]))
		if "kill2" in data:
			line = data.split(";")
			self.gs.kill2(line[1])

class ClientConnectionFactory(ClientFactory):
	def __init__(self, gs):
		self.myconn = ClientConnection(gs)
	
	def buildProtocol(self, addr):
		return self.myconn

		
class GameSpace:
	def __init__(self):
		pygame.init()
		self.size = self.width, self.height = 800, 600
		self.black = 0,0,0
		self.screen = pygame.display.set_mode(self.size)
		self.image = pygame.image.load("./likebook.png")
		self.rect = self.image.get_rect()
		self.state = "Connecting"
		self.clickCount = 0
		self.enemyCount = 0
		# self.fb = []
		# self.smokes = []
		# self.fades = []
		self.targs = []
		self.fb = pygame.sprite.Group()
		self.smokes = pygame.sprite.Group()
		self.fades = pygame.sprite.Group()
		self.screen.fill(self.black)
		self.myfont = pygame.font.Font(None, 35)
		self.ms = random.randint(30, 120)/100
		self.placed = 0
		
		self.screen.blit(self.image, self.rect)
		pygame.display.flip()
	
	def injectCC(self, CC):
		self.CC = CC
	
	def waitingMode(self):
		self.image = pygame.image.load("./CliWait.png")
		self.rect = self.image.get_rect()
		self.state = "Waiting"	
			
	def gameTime(self):
		self.image = pygame.image.load("./likebook.png")
		self.rect = self.image.get_rect()
		self.state = "Ready"	
		
	def kill2(self, num):
		self.enemyCount += 1
		self.targs[num].dead = 1
		for targ in self.targs:
			if targ.dead == 1:
				self.smokes.add(Smoke(self, targ.rect.center))
				self.targs.pop(self.targs.index(targ))
		
	def kill1(self):
		self.enemyCount += 1
		for targ in self.fb:
			self.smokes.add(Smoke(self, targ.rect.center))
			targ.kill()
		
	def gameMode2(self):
		# if(self.ms < time.time() - self.start):
			# self.fb.add(Target(self, random.randint(0, 750), random.randint(0, 550)))
			# self.start = time.time()
			# self.ms = random.randint(90, 210)/100
			
		for event in pygame.event.get():
			if event.type == pygame.MOUSEBUTTONDOWN:
				for targ in self.targs:
					if targ.rect.collidepoint(event.pos):
						self.clickCount += 1
						self.smokes.add(Fade(self, targ.rect.center))
						# targ.kill()
						self.CC.transport.write("kill2;{}".format(self.targs.index(targ))
						self.targs.pop(self.targs.index(targ))
						# self.placed = 0
						# self.start = time.time()
						# self.ms = random.randint(30, 120)/100
			# if event.type == pygame.KEYDOWN:
				# if chr(event.key) == 'q':
					# print "duck"
		for targ in self.targs:
			targ.tick()
		for smoke in self.smokes:
			smoke.tick()
		for fade in fades:
			fade.tick()
		label = self.myfont.render("Hits: {}     Enemy Hits: {}".format(self.clickCount, self.enemyCount), 1, (255, 255, 255))
		self.screen.blit(label, (250, 100))
		pygame.display.flip()
		self.screen.fill(self.black)
		return	
		
	def gameMode1(self):
		# if(self.ms < time.time() - self.start and self.placed == 0):
			# self.fb.add(Target(self, random.randint(0, 750), random.randint(0, 550)))
			# self.placed = 1
		for event in pygame.event.get():
			if event.type == pygame.MOUSEBUTTONDOWN:
				for targ in self.fb:
					if targ.rect.collidepoint(event.pos):
						self.clickCount += 1
						self.fades.add(Fade(self, targ.rect.center))
						#self.fades.append(Fade(self, targ.rect.center))
						targ.kill()
						self.CC.transport.write("kill1")
						#print ("Total clicked: ", self.clickCount)
						# self.placed = 0
						#self.start = time.time()
						#self.ms = random.randint(30, 120)/100
			# if event.type == pygame.KEYDOWN:
				# if chr(event.key) == 'q':
					# print "duck"
		for targ in self.fb:
			targ.tick()
		for smoke in self.smokes:
			smoke.tick()
		for fade in self.fades:
			fade.tick()
		label = self.myfont.render("Hits: {}    Enemy Hits: {}".format(self.clickCount, self.enemyCount), 1, (255, 255, 255))
		self.screen.blit(label, (250, 100))
		pygame.display.flip()
		self.screen.blit(self.image, self.rect)
		return
	
	defgameMode2(self):
	
	def main(self):
		if self.state == "Ready":
			self.gameMode1()
			return
			
		self.screen.blit(self.image, self.rect)

		pygame.display.flip()
		
			
		
if __name__=='__main__':

	gs = GameSpace()
	l = task.LoopingCall(gs.main)
	l.start(0.01666)
	ccf = ClientConnectionFactory(gs)
	reactor.connectTCP("ash.campus.nd.edu", 40035, ccf)
	reactor.run()